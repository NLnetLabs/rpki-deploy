---
version: "3.6"

services:
  nginx:
    container_name: nginx
    build:
      context: nginx
      network: host
    cap_add:
      - NET_ADMIN
    environment:
      - URL=$KRILL_FQDN  # the FQDN of the DNS record of the host (used by Lets Encrypt)
    ports:
      - "443:443"
      - "80:80"
    networks:
      - my-net
    restart: unless-stopped
    depends_on:
      - krill

  krill:
    image: nlnetlabs/krill:$KRILL_VERSION
    container_name: krill
    environment:
      - KRILL_AUTH_TOKEN
    volumes:
      - krill_data:/var/kill/data
      - rsync_data:/var/krill/data/repo/rsync/
      - /tmp/ka:/tmp/ka
      - /tmp/ka/krill.conf:/var/krill/data/krill.conf
    networks:
      - my-net
    restart: unless-stopped

  rsyncd:
    build:
      context: rsyncd
      network: host
    container_name: rsyncd
    ports:
      - "873:873"
    networks:
      - my-net
    volumes:
      - rsync_data:/share:ro
    restart: unless-stopped
  
  routinator:
    build:
      context: relyingparties/routinator
      network: host
    container_name: routinator
    dns: 8.8.8.8
    networks:
      - my-net
    environment:
      - KRILL_FQDN
      - SRC_TAL
    ports:
      - "3323:3323"
      - "9556:9556"
    restart: on-failure
    depends_on:
      - relyingpartybase

  octorpki:
    build:
      context: relyingparties/octorpki
      network: host
    container_name: octorpki
    dns: 8.8.8.8
    networks:
      - my-net
    environment:
      - KRILL_FQDN
      - SRC_TAL
      - RSYNC_BASE
    restart: on-failure
    depends_on:
      - relyingpartybase

  fortvalidator:
    build:
      context: relyingparties/fortvalidator
      network: host
    container_name: fortvalidator
    dns: 8.8.8.8
    networks:
      - my-net
    environment:
      - KRILL_FQDN
      - SRC_TAL
      - RSYNC_BASE
    restart: on-failure
    depends_on:
      - relyingpartybase

  rpkivalidator3:
    build:
      context: relyingparties/rpkivalidator3
      network: host
    container_name: rpkivalidator3
    dns: 8.8.8.8
    networks:
      - my-net
    environment:
      - KRILL_FQDN
      - SRC_TAL
      - RSYNC_BASE
    ports:
      - "8080:8080"
    restart: on-failure
    depends_on:
      - relyingpartybase
      - nginx

  rcynic:
    build:
      context: relyingparties/rcynic
      network: host
    container_name: rcynic
    dns: 8.8.8.8
    networks:
      - my-net
    environment:
      - KRILL_FQDN
      - KRILL_USE_TA
      - SRC_TAL
      - RSYNC_BASE
    restart: on-failure
    depends_on:
      - relyingpartybase

  rpkiclient:
    build:
      context: relyingparties/rpki-client
      network: host
    container_name: rpkiclient
    dns: 8.8.8.8
    networks:
      - my-net
    environment:
      - KRILL_FQDN
      - SRC_TAL
      - RSYNC_BASE
    restart: on-failure
    depends_on:
      - relyingpartybase

  relyingpartybase:
    image: relyingpartybase
    build:
      context: relyingparties/base
      network: host
    container_name: relyingpartybase

volumes:
  krill_data:
  
  rsync_data:

  tals:

networks:
  my-net:
    name: krill.test