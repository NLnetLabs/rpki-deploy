name: CI

on: push

jobs:
  krill_e2e_test_test:
    name: deploy_and_test
    runs-on: ubuntu-18.04
    steps:
    - name: Checkout Krill (master branch)
      uses: actions/checkout@v2
      with:
        repository: nlnetlabs/krill
        ref: master
        path: krill

    - name: Decrypt SSH key
      run: |
        echo "$SSH_KEY" > ${GITHUB_WORKSPACE}/ssh_key
        chmod 400 ${GITHUB_WORKSPACE}/ssh_key
      env:
        SSH_KEY: ${{ secrets.SSH_KEY }}

    - name: Deploy
      uses: docker://ximoneighteen/run-tests-action:latest
      with:
        ssh_key_path: ssh_key
        do_token: ${{ secrets.DO_TOKEN }}
        mode: deploy

    - name: Run tests
      uses: docker://ximoneighteen/run-tests-action:latest
      with:
        ssh_key_path: ssh_key
        do_token: ${{ secrets.DO_TOKEN }}
        mode: run-tests

    - name: Upload HTML test report
      uses: actions/upload-artifact@v1
      with:
        name: test-report
        path: ${GITHUB_WORKSPACE}/report.html

    - name: Undeploy
      if: always()
      uses: docker://ximoneighteen/run-tests-action:latest
      with:
        ssh_key_path: ssh_key
        do_token: ${{ secrets.DO_TOKEN }}
        mode: undeploy
